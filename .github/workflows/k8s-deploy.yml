name: Deploy to Kubernetes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - staging
          - production
        default: 'staging'
      image_tag:
        description: 'Docker image tag to deploy'
        required: true
        default: 'latest'
  
  push:
    branches:
      - main
    paths:
      - 'k8s/**'
      - '.github/workflows/k8s-deploy.yml'

env:
  KUBECONFIG_PATH: ${{ secrets.KUBECONFIG }}

jobs:
  # ============================================================
  # Stage 4: Deploy to Staging
  # ============================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.inventory-system.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.KUBECONFIG_STAGING }}" ]; then
            echo "âš ï¸  KUBECONFIG_STAGING secret is not configured!"
            echo ""
            echo "This workflow requires Kubernetes cluster access."
            echo "Please configure the following GitHub secrets:"
            echo "  - KUBECONFIG_STAGING: Base64-encoded kubeconfig for staging cluster"
            echo "  - KUBECONFIG_PRODUCTION: Base64-encoded kubeconfig for production cluster"
            echo ""
            echo "Alternative: Use ArgoCD for GitOps deployment (recommended)"
            echo "ArgoCD will automatically sync from this repository."
            echo ""
            echo "Skipping direct kubectl deployment..."
            exit 0
          fi
      
      - name: Configure kubectl
        if: secrets.KUBECONFIG_STAGING != ''
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_STAGING }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: Update image tags
        run: |
          TAG=${{ github.event.inputs.image_tag || 'latest' }}
          
          # Update all deployment manifests with new image tag
          find k8s/base -name "*-deployment.yaml" -exec sed -i "s|:latest|:${TAG}|g" {} \;
      
      - name: Apply Kubernetes manifests
        if: secrets.KUBECONFIG_STAGING != ''
        run: |
          kubectl apply -f k8s/base/namespace.yaml
          kubectl apply -f k8s/base/database/
          kubectl apply -f k8s/base/configmaps/
          kubectl apply -f k8s/base/secrets/
          kubectl apply -f k8s/base/deployments/
          kubectl apply -f k8s/base/services/
          kubectl apply -f k8s/base/hpa/
          kubectl apply -f k8s/security/
          kubectl apply -f k8s/monitoring/
      
      - name: Wait for rollout
        if: secrets.KUBECONFIG_STAGING != ''
        run: |
          kubectl rollout status deployment/user-service -n inventory-staging --timeout=5m
          kubectl rollout status deployment/product-catalog-service -n inventory-staging --timeout=5m
          kubectl rollout status deployment/inventory-service -n inventory-staging --timeout=5m
          kubectl rollout status deployment/order-service -n inventory-staging --timeout=5m
          kubectl rollout status deployment/supplier-service -n inventory-staging --timeout=5m
      
      - name: Verify deployment
        if: secrets.KUBECONFIG_STAGING != ''
        run: |
          kubectl get pods -n inventory-staging
          kubectl get services -n inventory-staging
          kubectl get hpa -n inventory-staging
      
      # ============================================================
      # Run Smoke Tests After Deployment
      # ============================================================
      - name: Run smoke tests
        if: secrets.KUBECONFIG_STAGING != ''
        run: |
          chmod +x scripts/smoke-tests/smoke-test.sh
          NAMESPACE=inventory-staging ./scripts/smoke-tests/smoke-test.sh
      
      - name: Rollback on failure
        if: failure() && secrets.KUBECONFIG_STAGING != ''
        run: |
          echo "Smoke tests failed! Rolling back..."
          kubectl rollout undo deployment/user-service -n inventory-staging
          kubectl rollout undo deployment/product-catalog-service -n inventory-staging
          kubectl rollout undo deployment/inventory-service -n inventory-staging
          kubectl rollout undo deployment/order-service -n inventory-staging
          kubectl rollout undo deployment/supplier-service -n inventory-staging
      
      - name: Notify success
        if: success()
        run: |
          echo "âœ… Staging deployment successful!"
          echo "Environment: https://staging.inventory-system.example.com"
      
      - name: Notify failure
        if: failure()
        run: |
          echo "âŒ Staging deployment failed!"
          echo "Check logs and smoke test results above."

  # ============================================================
  # Stage 5: Manual Approval for Production
  # ============================================================
  approval-gate:
    name: Approve Production Deployment
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment:
      name: production-approval
    
    steps:
      - name: Wait for approval
        run: |
          echo "â³ Waiting for manual approval to deploy to production..."
          echo "Staging tests passed. Ready for production deployment."
          echo ""
          echo "Review checklist:"
          echo "âœ… Staging smoke tests passed"
          echo "âœ… No critical bugs reported"
          echo "âœ… Change log reviewed"
          echo "âœ… Rollback plan confirmed"

  # ============================================================
  # Stage 6: Production Deployment (Blue-Green Strategy)
  # ============================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: approval-gate
    environment:
      name: production
      url: https://inventory-system.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.KUBECONFIG_PRODUCTION }}" ]; then
            echo "âš ï¸  KUBECONFIG_PRODUCTION secret is not configured!"
            echo "Please configure KUBECONFIG_PRODUCTION secret before production deployment."
            exit 1
          fi
      
      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: Update image tags
        run: |
          TAG=${{ github.event.inputs.image_tag || 'latest' }}
          find k8s/base -name "*-deployment.yaml" -exec sed -i "s|:latest|:${TAG}|g" {} \;
      
      # Blue-Green Deployment Strategy
      - name: Deploy green version
        run: |
          echo "ðŸŸ¢ Deploying green version..."
          
          # Apply manifests to production namespace
          kubectl apply -f k8s/base/namespace.yaml
          kubectl apply -f k8s/base/database/
          kubectl apply -f k8s/base/configmaps/
          kubectl apply -f k8s/base/secrets/
          kubectl apply -f k8s/base/deployments/
          
          # Services will be switched after validation
      
      - name: Wait for green deployment
        run: |
          kubectl rollout status deployment/user-service -n inventory-production --timeout=5m
          kubectl rollout status deployment/product-catalog-service -n inventory-production --timeout=5m
          kubectl rollout status deployment/inventory-service -n inventory-production --timeout=5m
          kubectl rollout status deployment/order-service -n inventory-production --timeout=5m
          kubectl rollout status deployment/supplier-service -n inventory-production --timeout=5m
      
      - name: Run production smoke tests
        run: |
          chmod +x scripts/smoke-tests/smoke-test.sh
          NAMESPACE=inventory-production ./scripts/smoke-tests/smoke-test.sh
      
      - name: Switch traffic to green
        if: success()
        run: |
          echo "ðŸ”„ Switching traffic to green version..."
          kubectl apply -f k8s/base/services/
          kubectl apply -f k8s/base/hpa/
          kubectl apply -f k8s/security/
          kubectl apply -f k8s/monitoring/
      
      - name: Verify production
        run: |
          kubectl get pods -n inventory-production
          kubectl get services -n inventory-production
          kubectl top pods -n inventory-production || true
      
      - name: Rollback on failure
        if: failure()
        run: |
          echo "âŒ Production deployment failed! Rolling back..."
          kubectl rollout undo deployment/user-service -n inventory-production
          kubectl rollout undo deployment/product-catalog-service -n inventory-production
          kubectl rollout undo deployment/inventory-service -n inventory-production
          kubectl rollout undo deployment/order-service -n inventory-production
          kubectl rollout undo deployment/supplier-service -n inventory-production
          
          echo "Rollback complete. Previous version restored."
          exit 1
      
      - name: Notify success
        if: success()
        run: |
          echo "âœ… Production deployment successful!"
          echo "Environment: https://inventory-system.example.com"
          echo ""
          echo "Deployment Details:"
          echo "- Strategy: Blue-Green"
          echo "- Image Tag: ${{ github.event.inputs.image_tag || 'latest' }}"
          echo "- Commit: ${{ github.sha }}"
      
      - name: Notify failure
        if: failure()
        run: |
          echo "âŒ Production deployment failed and rolled back!"
          echo "Previous version is still running."
          echo "Check logs above for details."

  # ============================================================
  # Deployment Summary
  # ============================================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Environment: ${{ github.event.inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "## Image Tag: ${{ github.event.inputs.image_tag || 'latest' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-staging.result }}" == "success" ]; then
            echo "âœ… Staging: **SUCCESS**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Staging: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.deploy-production.result }}" == "success" ]; then
            echo "âœ… Production: **SUCCESS**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.deploy-production.result }}" == "skipped" ]; then
            echo "â­ï¸ Production: **SKIPPED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Production: **FAILED**" >> $GITHUB_STEP_SUMMARY
          fi
