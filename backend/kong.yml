_format_version: "3.0"
_transform: true

# Kong Declarative Configuration for Local Development
# This file routes all API traffic through Kong Gateway with security, rate limiting, and monitoring

services:
  # ========================================
  # USER SERVICE
  # ========================================
  - name: user-service
    url: http://user-service:3001
    tags:
      - user-management
      - authentication
    routes:
      - name: user-auth-routes
        paths:
          - /api/auth
        methods:
          - GET
          - POST
        strip_path: false
        protocols:
          - http
          - https
      - name: user-management-routes
        paths:
          - /api/users
        methods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          hour: 5000
          policy: local
          fault_tolerant: true
      - name: cors
        config:
          origins:
            - "http://localhost:5173"
            - "http://localhost:3000"
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Authorization
            - Content-Type
            - X-Auth-Token
          exposed_headers:
            - X-Auth-Token
            - X-RateLimit-Limit
            - X-RateLimit-Remaining
          credentials: true
          max_age: 3600
      - name: request-size-limiting
        config:
          allowed_payload_size: 10
          size_unit: megabytes
      - name: prometheus
        config:
          per_consumer: false
          status_code_metrics: true
          latency_metrics: true
          bandwidth_metrics: true

  # ========================================
  # PRODUCT CATALOG SERVICE
  # ========================================
  - name: product-catalog-service
    url: http://product-catalog-service:3002
    tags:
      - product-management
      - catalog
    routes:
      - name: product-routes
        paths:
          - /api/products
        methods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
      - name: category-routes
        paths:
          - /api/categories
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: rate-limiting
        config:
          minute: 200
          hour: 10000
          policy: local
          fault_tolerant: true
      - name: cors
        config:
          origins:
            - "http://localhost:5173"
            - "http://localhost:3000"
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Authorization
            - Content-Type
          credentials: true
          max_age: 3600
      - name: request-size-limiting
        config:
          allowed_payload_size: 5
          size_unit: megabytes
      - name: prometheus
        config:
          per_consumer: false
      - name: request-transformer
        config:
          add:
            headers:
              - "X-Service:product-catalog"

  # ========================================
  # INVENTORY SERVICE
  # ========================================
  - name: inventory-service
    url: http://inventory-service:3003
    tags:
      - inventory
      - stock-management
    routes:
      - name: inventory-routes
        paths:
          - /api/inventory
        methods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
      - name: stock-routes
        paths:
          - /api/stock
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: rate-limiting
        config:
          minute: 200
          hour: 10000
          policy: local
          fault_tolerant: true
      - name: cors
        config:
          origins:
            - "http://localhost:5173"
            - "http://localhost:3000"
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Authorization
            - Content-Type
          credentials: true
          max_age: 3600
      - name: request-size-limiting
        config:
          allowed_payload_size: 5
          size_unit: megabytes
      - name: prometheus
        config:
          per_consumer: false
      - name: response-transformer
        config:
          add:
            headers:
              - "X-Service:inventory"

  # ========================================
  # SUPPLIER SERVICE
  # ========================================
  - name: supplier-service
    url: http://supplier-service:3004
    tags:
      - suppliers
      - procurement
    routes:
      - name: supplier-routes
        paths:
          - /api/suppliers
        methods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
      - name: purchase-order-routes
        paths:
          - /api/purchase-orders
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: rate-limiting
        config:
          minute: 100
          hour: 5000
          policy: local
          fault_tolerant: true
      - name: cors
        config:
          origins:
            - "http://localhost:5173"
            - "http://localhost:3000"
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Authorization
            - Content-Type
          credentials: true
          max_age: 3600
      - name: request-size-limiting
        config:
          allowed_payload_size: 5
          size_unit: megabytes
      - name: prometheus
        config:
          per_consumer: false

  # ========================================
  # ORDER SERVICE
  # ========================================
  - name: order-service
    url: http://order-service:3005
    tags:
      - orders
      - order-management
    routes:
      - name: order-routes
        paths:
          - /api/orders
        methods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
        strip_path: false
        protocols:
          - http
          - https
    plugins:
      - name: rate-limiting
        config:
          minute: 150
          hour: 7500
          policy: local
          fault_tolerant: true
      - name: cors
        config:
          origins:
            - "http://localhost:5173"
            - "http://localhost:3000"
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - PATCH
            - DELETE
            - OPTIONS
          headers:
            - Accept
            - Authorization
            - Content-Type
          credentials: true
          max_age: 3600
      - name: request-size-limiting
        config:
          allowed_payload_size: 5
          size_unit: megabytes
      - name: prometheus
        config:
          per_consumer: false
      - name: request-transformer
        config:
          add:
            headers:
              - "X-Service:order"

# ========================================
# GLOBAL PLUGINS
# ========================================
plugins:
  - name: correlation-id
    config:
      header_name: X-Correlation-ID
      generator: uuid
      echo_downstream: true
  - name: prometheus
    config:
      per_consumer: false

# ========================================
# UPSTREAMS (Load Balancing - Future)
# ========================================
upstreams:
  - name: user-service-upstream
    algorithm: round-robin
    hash_on: none
    hash_fallback: none
    slots: 100
    healthchecks:
      active:
        healthy:
          interval: 5
          successes: 2
        unhealthy:
          interval: 5
          tcp_failures: 2
          http_failures: 3
        http_path: /health
        timeout: 1
      passive:
        healthy:
          successes: 2
        unhealthy:
          http_failures: 3
    targets:
      - target: user-service:3001
        weight: 100
